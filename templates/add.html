<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</h1>
            <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('receipt')">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('writeoff')">–°–ø–∏—Å–∞–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('object')">–û–±—ä–µ–∫—Ç</button>
            <button class="tab" onclick="showTab('seller')">–ü–æ—Å—Ç–∞–≤—â–∏–∫</button>
            <button class="tab" onclick="showTab('theme')">–¢–µ–º–∞</button>
        </div>

        <div id="tab-receipt" class="tab-content active">
            <form id="receipt-form" class="form-card">
                <h3>–ù–æ–≤–æ–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>

                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                    <select id="objectId" name="objectId">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π --</option>
                    </select>
                    <input type="text" id="newObjectName" name="newObjectName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç">
                </div>

                <div class="form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</label>
                    <input type="text" name="sellerObjectName" required>
                </div>

                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" name="quantity" min="1" required>
                </div>

                <div class="form-group">
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select id="sellerId" name="sellerId">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ --</option>
                    </select>
                    <div class="new-seller-fields" style="display: none;">
                        <input type="text" name="newSellerName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                        <input type="text" name="newSellerInn" placeholder="–ò–ù–ù">
                        <input type="text" name="newSellerKpp" placeholder="–ö–ü–ü">
                    </div>
                    <button type="button" class="btn btn-small" onclick="toggleNewSeller()">+ –ù–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫</button>
                </div>

                <div class="form-group">
                    <label>–¢–µ–º–∞</label>
                    <select id="themeId" name="themeId">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é --</option>
                    </select>
                    <input type="text" name="newThemeName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ç–µ–º—É">
                </div>

                <div class="form-group">
                    <label>–°—á—ë—Ç (–Ω–æ–º–µ—Ä –∏ —Ñ–∞–π–ª)</label>
                    <input type="text" name="billNumber" placeholder="–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞" required>
                    <input type="date" name="billDate" required>
                    <input type="file" name="billFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                </div>

                <div class="form-group">
                    <label>–ù–∞–∫–ª–∞–¥–Ω–∞—è (–Ω–æ–º–µ—Ä –∏ —Ñ–∞–π–ª)</label>
                    <input type="text" name="invoiceNumber" placeholder="–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π" required>
                    <input type="date" name="invoiceDate" required>
                    <input type="file" name="invoiceFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                </div>

                <div class="form-group">
                    <label>–í—Ö–æ–¥–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–Ω–æ–º–µ—Ä –∏ —Ñ–∞–π–ª)</label>
                    <input type="text" name="entryControlNumber" placeholder="–ù–æ–º–µ—Ä" required>
                    <input type="date" name="entryControlDate" required>
                    <input type="file" name="entryControlFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                </div>

                <div class="form-group">
                    <label>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                    <input type="text" name="location" placeholder="–°–∫–ª–∞–¥ –ê">
                </div>

                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
            </form>
        </div>

        <div id="tab-writeoff" class="tab-content">
            <form id="writeoff-form" class="form-card">
                <h3>–ù–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ</h3>

                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                    <select id="writeoffObjectId" name="objectId" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
                    <select id="writeoffThemeId" name="themeId">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é --</option>
                    </select>
                    <input type="text" name="newThemeName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ç–µ–º—É">
                </div>

                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" name="quantity" min="1" required>
                </div>

                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ</button>
            </form>
        </div>

        <div id="tab-object" class="tab-content">
            <form id="object-form" class="form-card">
                <h3>–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</h3>

                <div class="form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
                    <input type="text" name="objectName" required>
                </div>

                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç</button>
            </form>
        </div>

        <div id="tab-seller" class="tab-content">
            <form id="seller-form" class="form-card">
                <h3>–ù–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫</h3>

                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                    <input type="text" name="name" required>
                </div>

                <div class="form-group">
                    <label>–ò–ù–ù</label>
                    <input type="text" name="inn" required>
                </div>

                <div class="form-group">
                    <label>–ö–ü–ü</label>
                    <input type="text" name="kpp" required>
                </div>

                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</button>
            </form>
        </div>

        <div id="tab-theme" class="tab-content">
            <form id="theme-form" class="form-card">
                <h3>–ù–æ–≤–∞—è —Ç–µ–º–∞</h3>

                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã</label>
                    <input type="text" name="name" required>
                </div>

                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon" id="modal-icon">‚úì</div>
            <div class="modal-title" id="modal-title">–£—Å–ø–µ—à–Ω–æ!</div>
            <div class="modal-message" id="modal-message"></div>
            <button class="btn btn-primary modal-btn" onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSelectors();
            setupForms();
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function toggleNewSeller() {
            const fields = document.querySelector('.new-seller-fields');
            fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
        }

        async function loadSelectors() {
            const [objects, sellers, themes] = await Promise.all([
                fetch('/api/objects').then(r => r.json()),
                fetch('/api/sellers').then(r => r.json()),
                fetch('/api/themes').then(r => r.json())
            ]);

            populateSelect('objectId', objects, 'id', 'objectname');
            populateSelect('writeoffObjectId', objects, 'id', 'objectname');
            populateSelect('sellerId', sellers, 'id', 'name');
            populateSelect('themeId', themes, 'id', 'name');
            populateSelect('writeoffThemeId', themes, 'id', 'name');
        }

        function populateSelect(selectId, items, valueKey, textKey) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            const firstOption = select.querySelector('option');

            select.innerHTML = '';
            if (firstOption) select.appendChild(firstOption);

            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                select.appendChild(option);
            });

            select.value = currentValue;
        }

        function setupForms() {
            document.getElementById('receipt-form').addEventListener('submit', e => {
                e.preventDefault();
                submitForm('/api/receipt', new FormData(e.target), e.target);
            });

            document.getElementById('writeoff-form').addEventListener('submit', e => {
                e.preventDefault();
                submitForm('/api/writeoff', new FormData(e.target), e.target);
            });

            document.getElementById('object-form').addEventListener('submit', e => {
                e.preventDefault();
                submitForm('/api/object', new FormData(e.target), e.target);
            });

            document.getElementById('seller-form').addEventListener('submit', e => {
                e.preventDefault();
                submitForm('/api/seller', new FormData(e.target), e.target);
            });

            document.getElementById('theme-form').addEventListener('submit', e => {
                e.preventDefault();
                submitForm('/api/theme', new FormData(e.target), e.target);
            });
        }

        async function submitForm(url, formData, form) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.error) {
                    showModal(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showModal(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    form.reset();
                    loadSelectors();
                }
            } catch (error) {
                showModal(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function showModal(success, title, message) {
            const overlay = document.getElementById('modal-overlay');
            const icon = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');

            icon.textContent = success ? '‚úì' : '‚úó';
            icon.className = 'modal-icon ' + (success ? 'success' : 'error');
            titleEl.textContent = title;
            messageEl.textContent = message;

            overlay.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        document.getElementById('modal-overlay').addEventListener('click', e => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });
    </script>
</body>
</html>