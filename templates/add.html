<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .field-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.25) !important;
        }
        .field-error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 2px;
            display: none;
        }
        .field-error-message.visible {
            display: block;
        }
        .form-group.has-error label {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</h1>
            <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('receipt')">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('writeoff')">–°–ø–∏—Å–∞–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('object')">–û–±—ä–µ–∫—Ç</button>
            <button class="tab" onclick="showTab('seller')">–ü–æ—Å—Ç–∞–≤—â–∏–∫</button>
            <button class="tab" onclick="showTab('theme')">–¢–µ–º–∞</button>
        </div>

        <!-- ==================== –ü–û–°–¢–£–ü–õ–ï–ù–ò–ï ==================== -->
        <div id="tab-receipt" class="tab-content active">
            <div class="form-card">
                <h3>–ù–æ–≤–æ–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>

                <div class="form-row">
                    <div class="form-group flex-2" id="fg-r-object">
                        <label>–û–±—ä–µ–∫—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ *</label>
                        <select id="r-objectId">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π --</option>
                        </select>
                        <input type="text" id="r-newObjectName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç">
                        <div class="field-error-message" id="err-r-object">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π</div>
                    </div>
                    <div class="form-group flex-1" id="fg-r-quantity">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                        <input type="number" id="r-quantity" min="1" oninput="calculateTotal(); clearError('fg-r-quantity')">
                        <div class="field-error-message" id="err-r-quantity">–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                    </div>
                </div>

                <div class="form-group" id="fg-r-sellerObjectName">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ *</label>
                    <input type="text" id="r-sellerObjectName" oninput="clearError('fg-r-sellerObjectName')">
                    <div class="field-error-message" id="err-r-sellerObjectName">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
                </div>

                <div class="price-block">
                    <h4>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</h4>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label>–¶–µ–Ω–∞ –∑–∞ —à—Ç. (–±–µ–∑ –ù–î–°)</label>
                            <input type="number" id="r-price" step="0.01" min="0" placeholder="0.00" oninput="calculateTotal()">
                        </div>
                        <div class="form-group flex-1">
                            <label>–ù–î–° (%)</label>
                            <select id="r-tax" onchange="calculateTotal()">
                                <option value="0">0%</option>
                                <option value="10">10%</option>
                                <option value="20" selected>20%</option>
                            </select>
                        </div>
                        <div class="form-group flex-1">
                            <label>–¶–µ–Ω–∞ —Å –ù–î–°</label>
                            <input type="text" id="r-priceWithTax" readonly class="calculated-field">
                        </div>
                        <div class="form-group flex-1">
                            <label>–°—É–º–º–∞</label>
                            <input type="text" id="r-totalPrice" readonly class="calculated-field total-field">
                        </div>
                    </div>
                </div>

                <div class="form-group" id="fg-r-seller">
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫ *</label>
                    <select id="r-sellerId" onchange="clearError('fg-r-seller')">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ --</option>
                    </select>
                    <div id="new-seller-fields" style="display: none;">
                        <input type="text" id="r-newSellerName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏" oninput="clearError('fg-r-seller')">
                        <input type="text" id="r-newSellerInn" placeholder="–ò–ù–ù">
                        <input type="text" id="r-newSellerKpp" placeholder="–ö–ü–ü">
                    </div>
                    <button type="button" class="btn btn-small" onclick="toggleNewSeller()">+ –ù–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫</button>
                    <div class="field-error-message" id="err-r-seller">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ</div>
                </div>

                <div class="form-group" id="fg-r-theme">
                    <label>–¢–µ–º–∞ *</label>
                    <select id="r-themeId" onchange="clearError('fg-r-theme')">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é --</option>
                    </select>
                    <input type="text" id="r-newThemeName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ç–µ–º—É" oninput="clearError('fg-r-theme')">
                    <div class="field-error-message" id="err-r-theme">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é</div>
                </div>

                <div class="form-row">
                    <div class="form-group flex-1" id="fg-r-billNumber">
                        <label>–°—á—ë—Ç (–Ω–æ–º–µ—Ä) *</label>
                        <input type="text" id="r-billNumber" placeholder="–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞" oninput="clearError('fg-r-billNumber')">
                        <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—á—ë—Ç–∞</div>
                    </div>
                    <div class="form-group flex-1" id="fg-r-billDate">
                        <label>–î–∞—Ç–∞ —Å—á—ë—Ç–∞ *</label>
                        <input type="date" id="r-billDate" onchange="clearError('fg-r-billDate')">
                        <div class="field-error-message">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Å—á—ë—Ç–∞</div>
                    </div>
                    <div class="form-group flex-1">
                        <label>–§–∞–π–ª —Å—á—ë—Ç–∞</label>
                        <input type="file" id="r-billFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group flex-1" id="fg-r-invoiceNumber">
                        <label>–ù–∞–∫–ª–∞–¥–Ω–∞—è (–Ω–æ–º–µ—Ä) *</label>
                        <input type="text" id="r-invoiceNumber" placeholder="–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π" oninput="clearError('fg-r-invoiceNumber')">
                        <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π</div>
                    </div>
                    <div class="form-group flex-1" id="fg-r-invoiceDate">
                        <label>–î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π *</label>
                        <input type="date" id="r-invoiceDate" onchange="clearError('fg-r-invoiceDate')">
                        <div class="field-error-message">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –Ω–∞–∫–ª–∞–¥–Ω–æ–π</div>
                    </div>
                    <div class="form-group flex-1">
                        <label>–§–∞–π–ª –Ω–∞–∫–ª–∞–¥–Ω–æ–π</label>
                        <input type="file" id="r-invoiceFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group flex-1" id="fg-r-ecNumber">
                        <label>–í—Ö–æ–¥–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–Ω–æ–º–µ—Ä) *</label>
                        <input type="text" id="r-entryControlNumber" placeholder="–ù–æ–º–µ—Ä" oninput="clearError('fg-r-ecNumber')">
                        <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</div>
                    </div>
                    <div class="form-group flex-1" id="fg-r-ecDate">
                        <label>–î–∞—Ç–∞ –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è *</label>
                        <input type="date" id="r-entryControlDate" onchange="clearError('fg-r-ecDate')">
                        <div class="field-error-message">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</div>
                    </div>
                    <div class="form-group flex-1">
                        <label>–§–∞–π–ª –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</label>
                        <input type="file" id="r-entryControlFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                    </div>
                </div>

                <div class="form-group" id="fg-r-location">
                    <label>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è *</label>
                    <input type="text" id="r-location" placeholder="–°–∫–ª–∞–¥ –ê" oninput="clearError('fg-r-location')">
                    <div class="field-error-message">–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
                </div>

                <button type="button" class="btn btn-primary btn-large" onclick="submitReceipt()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ
                </button>
            </div>
        </div>

        <!-- ==================== –°–ü–ò–°–ê–ù–ò–ï ==================== -->
        <div id="tab-writeoff" class="tab-content">
            <div class="form-card">
                <h3>–ù–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ</h3>

                <div class="form-group" id="fg-w-objectId">
                    <label>–û–±—ä–µ–∫—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ *</label>
                    <select id="w-objectId" onchange="clearError('fg-w-objectId')">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>
                    </select>
                    <div class="field-error-message">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</div>
                </div>

                <div class="form-group" id="fg-w-date">
                    <label>–î–∞—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è *</label>
                    <input type="date" id="w-date" onchange="clearError('fg-w-date')">
                    <div class="field-error-message">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Å–ø–∏—Å–∞–Ω–∏—è</div>
                </div>

                <div class="form-group">
                    <label>–î–æ–∫—É–º–µ–Ω—Ç</label>
                    <input type="file" id="w-document" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                </div>

                <div class="form-group" id="fg-w-quantity">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <input type="number" id="w-quantity" min="1" oninput="clearError('fg-w-quantity')">
                    <div class="field-error-message">–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                </div>

                <div class="form-group" id="fg-w-theme">
                    <label>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è *</label>
                    <select id="w-themeId" onchange="clearError('fg-w-theme')">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é --</option>
                    </select>
                    <input type="text" id="w-newThemeName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ç–µ–º—É" oninput="clearError('fg-w-theme')">
                    <div class="field-error-message">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é</div>
                </div>

                <button type="button" class="btn btn-primary btn-large" onclick="submitWriteoff()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ
                </button>
            </div>
        </div>

        <!-- ==================== –û–ë–™–ï–ö–¢ ==================== -->
        <div id="tab-object" class="tab-content">
            <div class="form-card">
                <h3>–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</h3>
                <div class="form-group" id="fg-o-objectName">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ *</label>
                    <input type="text" id="o-objectName" oninput="clearError('fg-o-objectName')">
                    <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
                </div>
                <button type="button" class="btn btn-primary btn-large" onclick="submitObject()">
                    –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç
                </button>
            </div>
        </div>

        <!-- ==================== –ü–û–°–¢–ê–í–©–ò–ö ==================== -->
        <div id="tab-seller" class="tab-content">
            <div class="form-card">
                <h3>–ù–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫</h3>
                <div class="form-group" id="fg-s-name">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ *</label>
                    <input type="text" id="s-name" oninput="clearError('fg-s-name')">
                    <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
                </div>
                <div class="form-row">
                    <div class="form-group flex-1" id="fg-s-inn">
                        <label>–ò–ù–ù *</label>
                        <input type="text" id="s-inn" oninput="clearError('fg-s-inn')">
                        <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù</div>
                    </div>
                    <div class="form-group flex-1" id="fg-s-kpp">
                        <label>–ö–ü–ü *</label>
                        <input type="text" id="s-kpp" oninput="clearError('fg-s-kpp')">
                        <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –ö–ü–ü</div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-large" onclick="submitSeller()">
                    –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                </button>
            </div>
        </div>

        <!-- ==================== –¢–ï–ú–ê ==================== -->
        <div id="tab-theme" class="tab-content">
            <div class="form-card">
                <h3>–ù–æ–≤–∞—è —Ç–µ–º–∞</h3>
                <div class="form-group" id="fg-t-name">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã *</label>
                    <input type="text" id="t-name" oninput="clearError('fg-t-name')">
                    <div class="field-error-message">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã</div>
                </div>
                <button type="button" class="btn btn-primary btn-large" onclick="submitTheme()">
                    –°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon" id="modal-icon">‚úì</div>
            <div class="modal-title" id="modal-title">–£—Å–ø–µ—à–Ω–æ!</div>
            <div class="modal-message" id="modal-message"></div>
            <button class="btn btn-primary modal-btn" onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        let isSubmitting = false;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadSelectors();
            calculateTotal();
        });

        // ==================== VALIDATION ====================
        function setError(groupId) {
            const group = document.getElementById(groupId);
            if (!group) return;
            group.classList.add('has-error');
            const inputs = group.querySelectorAll('input, select');
            inputs.forEach(input => input.classList.add('field-error'));
            const msg = group.querySelector('.field-error-message');
            if (msg) msg.classList.add('visible');
        }

        function clearError(groupId) {
            const group = document.getElementById(groupId);
            if (!group) return;
            group.classList.remove('has-error');
            const inputs = group.querySelectorAll('input, select');
            inputs.forEach(input => input.classList.remove('field-error'));
            const msg = group.querySelector('.field-error-message');
            if (msg) msg.classList.remove('visible');
        }

        function clearAllErrors() {
            document.querySelectorAll('.has-error').forEach(el => {
                el.classList.remove('has-error');
            });
            document.querySelectorAll('.field-error').forEach(el => {
                el.classList.remove('field-error');
            });
            document.querySelectorAll('.field-error-message.visible').forEach(el => {
                el.classList.remove('visible');
            });
        }

        function validateField(groupId, value) {
            const val = (value || '').toString().trim();
            if (!val) {
                setError(groupId);
                return false;
            }
            clearError(groupId);
            return true;
        }

        function scrollToFirstError() {
            const firstError = document.querySelector('.has-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const input = firstError.querySelector('input, select');
                if (input) input.focus();
            }
        }

        // ==================== AUTH ====================
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                if (!data.authenticated) {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
        }

        // ==================== TABS ====================
        function showTab(tabName) {
            clearAllErrors();
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function toggleNewSeller() {
            const fields = document.getElementById('new-seller-fields');
            fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
        }

        // ==================== PRICE CALC ====================
        function calculateTotal() {
            const quantity = parseFloat(document.getElementById('r-quantity').value) || 0;
            const price = parseFloat(document.getElementById('r-price').value) || 0;
            const tax = parseFloat(document.getElementById('r-tax').value) || 0;

            const priceWithTax = price * (1 + tax / 100);
            const total = priceWithTax * quantity;

            document.getElementById('r-priceWithTax').value =
                price > 0 ? formatCurrency(priceWithTax) : '';
            document.getElementById('r-totalPrice').value =
                price > 0 && quantity > 0 ? formatCurrency(total) : '';
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB'
            }).format(value);
        }

        // ==================== SELECTORS ====================
        async function loadSelectors() {
            try {
                const [objects, sellers, themes] = await Promise.all([
                    fetch('/api/objects').then(r => r.json()),
                    fetch('/api/sellers').then(r => r.json()),
                    fetch('/api/themes').then(r => r.json())
                ]);

                populateSelect('r-objectId', objects, 'id', 'objectname');
                populateSelect('w-objectId', objects, 'id', 'objectname');
                populateSelect('r-sellerId', sellers, 'id', 'name');
                populateSelect('r-themeId', themes, 'id', 'name');
                populateSelect('w-themeId', themes, 'id', 'name');
            } catch (error) {
                console.error('Failed to load selectors:', error);
            }
        }

        function populateSelect(selectId, items, valueKey, textKey) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if (firstOption) select.appendChild(firstOption);

            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                select.appendChild(option);
            });
        }

        // ==================== SUBMIT: RECEIPT ====================
        async function submitReceipt() {
            if (isSubmitting) return;
            clearAllErrors();

            const objectId = document.getElementById('r-objectId').value;
            const newObjectName = document.getElementById('r-newObjectName').value.trim();
            const quantity = document.getElementById('r-quantity').value;
            const sellerObjectName = document.getElementById('r-sellerObjectName').value.trim();
            const sellerId = document.getElementById('r-sellerId').value;
            const newSellerName = document.getElementById('r-newSellerName').value.trim();
            const themeId = document.getElementById('r-themeId').value;
            const newThemeName = document.getElementById('r-newThemeName').value.trim();
            const billNumber = document.getElementById('r-billNumber').value.trim();
            const billDate = document.getElementById('r-billDate').value;
            const invoiceNumber = document.getElementById('r-invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('r-invoiceDate').value;
            const ecNumber = document.getElementById('r-entryControlNumber').value.trim();
            const ecDate = document.getElementById('r-entryControlDate').value;
            const location = document.getElementById('r-location').value.trim();

            let isValid = true;

            if (!objectId && !newObjectName) {
                setError('fg-r-object');
                isValid = false;
            }
            if (!validateField('fg-r-quantity', quantity)) isValid = false;
            if (!validateField('fg-r-sellerObjectName', sellerObjectName)) isValid = false;
            if (!sellerId && !newSellerName) {
                setError('fg-r-seller');
                isValid = false;
            }
            if (!themeId && !newThemeName) {
                setError('fg-r-theme');
                isValid = false;
            }
            if (!validateField('fg-r-billNumber', billNumber)) isValid = false;
            if (!validateField('fg-r-billDate', billDate)) isValid = false;
            if (!validateField('fg-r-invoiceNumber', invoiceNumber)) isValid = false;
            if (!validateField('fg-r-invoiceDate', invoiceDate)) isValid = false;
            if (!validateField('fg-r-ecNumber', ecNumber)) isValid = false;
            if (!validateField('fg-r-ecDate', ecDate)) isValid = false;
            if (!validateField('fg-r-location', location)) isValid = false;

            if (!isValid) {
                scrollToFirstError();
                return;
            }

            isSubmitting = true;

            const formData = new FormData();
            formData.append('objectId', objectId);
            formData.append('newObjectName', newObjectName);
            formData.append('sellerObjectName', sellerObjectName);
            formData.append('quantity', quantity);
            formData.append('sellerId', sellerId);
            formData.append('newSellerName', newSellerName);
            formData.append('newSellerInn', document.getElementById('r-newSellerInn').value);
            formData.append('newSellerKpp', document.getElementById('r-newSellerKpp').value);
            formData.append('themeId', themeId);
            formData.append('newThemeName', newThemeName);
            formData.append('billNumber', billNumber);
            formData.append('billDate', billDate);
            formData.append('invoiceNumber', invoiceNumber);
            formData.append('invoiceDate', invoiceDate);
            formData.append('entryControlNumber', ecNumber);
            formData.append('entryControlDate', ecDate);
            formData.append('location', location);

            const billFile = document.getElementById('r-billFile');
            if (billFile.files.length > 0) formData.append('billFile', billFile.files[0]);

            const invoiceFile = document.getElementById('r-invoiceFile');
            if (invoiceFile.files.length > 0) formData.append('invoiceFile', invoiceFile.files[0]);

            const ecFile = document.getElementById('r-entryControlFile');
            if (ecFile.files.length > 0) formData.append('entryControlFile', ecFile.files[0]);

            const price = document.getElementById('r-price').value;
            const tax = document.getElementById('r-tax').value;

            try {
                const response = await fetch('/api/receipt', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    showModal(false, '–û—à–∏–±–∫–∞', result.error);
                    isSubmitting = false;
                    return;
                }

                if (price && parseFloat(price) > 0) {
                    const pricingData = new FormData();
                    pricingData.append('receiptId', result.id);
                    pricingData.append('price', price);
                    pricingData.append('tax', tax);

                    await fetch('/api/pricing', {
                        method: 'POST',
                        body: pricingData
                    });
                }

                showModal(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                clearReceiptForm();
                loadSelectors();
            } catch (error) {
                showModal(false, '–û—à–∏–±–∫–∞', error.message);
            } finally {
                isSubmitting = false;
            }
        }

        function clearReceiptForm() {
            const ids = [
                'r-objectId', 'r-newObjectName', 'r-sellerObjectName',
                'r-quantity', 'r-price', 'r-priceWithTax', 'r-totalPrice',
                'r-sellerId', 'r-newSellerName', 'r-newSellerInn',
                'r-newSellerKpp', 'r-themeId', 'r-newThemeName',
                'r-billNumber', 'r-billDate', 'r-billFile',
                'r-invoiceNumber', 'r-invoiceDate', 'r-invoiceFile',
                'r-entryControlNumber', 'r-entryControlDate',
                'r-entryControlFile', 'r-location'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = el.tagName === 'SELECT' ? '' : '';
            });
            document.getElementById('r-tax').value = '20';
            clearAllErrors();
        }

        // ==================== SUBMIT: WRITEOFF ====================
        async function submitWriteoff() {
            if (isSubmitting) return;
            clearAllErrors();

            const objectId = document.getElementById('w-objectId').value;
            const writeoffDate = document.getElementById('w-date').value;
            const quantity = document.getElementById('w-quantity').value;
            const themeId = document.getElementById('w-themeId').value;
            const newThemeName = document.getElementById('w-newThemeName').value.trim();
            const fileInput = document.getElementById('w-document');

            let isValid = true;

            if (!validateField('fg-w-objectId', objectId)) isValid = false;
            if (!validateField('fg-w-date', writeoffDate)) isValid = false;
            if (!validateField('fg-w-quantity', quantity)) isValid = false;
            if (!themeId && !newThemeName) {
                setError('fg-w-theme');
                isValid = false;
            }

            if (!isValid) {
                scrollToFirstError();
                return;
            }

            isSubmitting = true;

            const formData = new FormData();
            formData.append('objectId', objectId);
            formData.append('writeoffDate', writeoffDate);
            formData.append('quantity', quantity);
            formData.append('themeId', themeId);
            formData.append('newThemeName', newThemeName);

            if (fileInput.files.length > 0) {
                formData.append('writeoffDocument', fileInput.files[0]);
            }

            try {
                const response = await fetch('/api/writeoff', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    showModal(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showModal(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    clearWriteoffForm();
                    loadSelectors();
                }
            } catch (error) {
                showModal(false, '–û—à–∏–±–∫–∞', error.message);
            } finally {
                isSubmitting = false;
            }
        }

        function clearWriteoffForm() {
            document.getElementById('w-objectId').value = '';
            document.getElementById('w-date').value = '';
            document.getElementById('w-document').value = '';
            document.getElementById('w-quantity').value = '';
            document.getElementById('w-themeId').value = '';
            document.getElementById('w-newThemeName').value = '';
            clearAllErrors();
        }

        // ==================== SUBMIT: OBJECT ====================
        async function submitObject() {
            if (isSubmitting) return;
            clearAllErrors();

            const objectName = document.getElementById('o-objectName').value.trim();

            if (!validateField('fg-o-objectName', objectName)) {
                scrollToFirstError();
                return;
            }

            isSubmitting = true;

            const formData = new FormData();
            formData.append('objectName', objectName);

            try {
                const response = await fetch('/api/object', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    showModal(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showModal(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    document.getElementById('o-objectName').value = '';
                    loadSelectors();
                }
            } catch (error) {
                showModal(false, '–û—à–∏–±–∫–∞', error.message);
            } finally {
                isSubmitting = false;
            }
        }

        // ==================== SUBMIT: SELLER ====================
        async function submitSeller() {
            if (isSubmitting) return;
            clearAllErrors();

            const name = document.getElementById('s-name').value.trim();
            const inn = document.getElementById('s-inn').value.trim();
            const kpp = document.getElementById('s-kpp').value.trim();

            let isValid = true;
            if (!validateField('fg-s-name', name)) isValid = false;
            if (!validateField('fg-s-inn', inn)) isValid = false;
            if (!validateField('fg-s-kpp', kpp)) isValid = false;

            if (!isValid) {
                scrollToFirstError();
                return;
            }

            isSubmitting = true;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('inn', inn);
            formData.append('kpp', kpp);

            try {
                const response = await fetch('/api/seller', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    showModal(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showModal(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    document.getElementById('s-name').value = '';
                    document.getElementById('s-inn').value = '';
                    document.getElementById('s-kpp').value = '';
                    loadSelectors();
                }
            } catch (error) {
                showModal(false, '–û—à–∏–±–∫–∞', error.message);
            } finally {
                isSubmitting = false;
            }
        }

        // ==================== SUBMIT: THEME ====================
        async function submitTheme() {
            if (isSubmitting) return;
            clearAllErrors();

            const name = document.getElementById('t-name').value.trim();

            if (!validateField('fg-t-name', name)) {
                scrollToFirstError();
                return;
            }

            isSubmitting = true;

            const formData = new FormData();
            formData.append('name', name);

            try {
                const response = await fetch('/api/theme', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    showModal(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showModal(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    document.getElementById('t-name').value = '';
                    loadSelectors();
                }
            } catch (error) {
                showModal(false, '–û—à–∏–±–∫–∞', error.message);
            } finally {
                isSubmitting = false;
            }
        }

        // ==================== MODAL ====================
        function showModal(success, title, message) {
            const overlay = document.getElementById('modal-overlay');
            const icon = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');

            icon.textContent = success ? '‚úì' : '‚úó';
            icon.className = 'modal-icon ' + (success ? 'success' : 'error');
            titleEl.textContent = title;
            messageEl.textContent = message;

            overlay.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        document.getElementById('modal-overlay').addEventListener('click', e => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>