<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>üì¶ –°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤</h1>
            <div class="header-buttons">
                <a href="/add" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å</a>
                <a href="/manage" class="btn btn-secondary">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="user-panel" id="user-panel">
            <div class="user-info" id="user-info" style="display: none;">
                <span id="user-name"></span>
                <button class="btn btn-small btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            <div class="login-prompt" id="login-prompt">
                <span>–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è </span>
                <button class="btn btn-small btn-primary" onclick="showLoginModal()">–í–æ–π—Ç–∏</button>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –ø–æ–∏—Å–∫–∞ -->
        <div class="search-panel">
            <div class="search-row">
                <select id="search-type" class="search-select" onchange="onSearchTypeChange()">
                    <option value="name">–ù–∞–∑–≤–∞–Ω–∏–µ</option>
                    <option value="seller_name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</option>
                    <option value="theme">–¢–µ–º–∞</option>
                    <option value="bill">–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞</option>
                    <option value="invoice">–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π</option>
                </select>
                <input type="text" id="search-input" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                <select id="search-theme-select" class="search-select" style="display: none;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>
                </select>
                <button class="btn btn-primary" onclick="performSearch()">üîç –ü–æ–∏—Å–∫</button>
                <button class="btn btn-secondary" onclick="resetSearch()">‚úñ –°–±—Ä–æ—Å</button>
            </div>
            <div id="search-info" class="search-info" style="display: none;"></div>
        </div>

        <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="objects-list"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
    <div id="edit-receipt-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>
            <form id="edit-receipt-form">
                <input type="hidden" id="receipt-id" name="id">
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <select id="receipt-object-id" name="objectId" required></select>
                </div>
                <div class="form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</label>
                    <input type="text" id="receipt-seller-object-name" name="sellerObjectName" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="receipt-quantity" name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select id="receipt-seller-id" name="sellerId" required></select>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞</label>
                    <select id="receipt-theme-id" name="themeId" required></select>
                </div>
                <div class="form-group">
                    <label>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                    <input type="text" id="receipt-location" name="location">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReceiptModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div id="edit-writeoff-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è</h3>
            <form id="edit-writeoff-form">
                <input type="hidden" id="writeoff-id" name="id">
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <select id="writeoff-object-id" name="objectId" required></select>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="writeoff-quantity" name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
                    <select id="writeoff-theme-id" name="themeId" required></select>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeWriteoffModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon error">!</div>
            <div class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</div>
            <div class="modal-message" id="delete-message"></div>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="confirm-delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon" id="message-icon">‚úì</div>
            <div class="modal-title" id="message-title">–£—Å–ø–µ—à–Ω–æ!</div>
            <div class="modal-message" id="message-text"></div>
            <button class="btn btn-primary modal-btn" onclick="closeMessageModal()">OK</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <form id="login-form">
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="login-username" name="username" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" name="password" required>
                </div>
                <div id="login-error" class="error-message" style="display: none;"></div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLoginModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let objectsCache = [];
        let sellersCache = [];
        let themesCache = [];
        let currentDeleteType = '';
        let currentDeleteId = null;
        let currentObjectId = null;
        let expandedObjects = new Set();
        let isSearchActive = false;
        let searchResults = {};
        let currentSearchTerm = '';
        let currentSearchType = '';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadObjects();
            loadSelectorsData();
            document.getElementById('edit-receipt-form').addEventListener('submit', handleReceiptSubmit);
            document.getElementById('edit-writeoff-form').addEventListener('submit', handleWriteoffSubmit);

            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });

        async function loadSelectorsData() {
            const [objects, sellers, themes] = await Promise.all([
                fetch('/api/objects').then(r => r.json()),
                fetch('/api/sellers').then(r => r.json()),
                fetch('/api/themes').then(r => r.json())
            ]);
            objectsCache = objects;
            sellersCache = sellers;
            themesCache = themes;

            const themeSelect = document.getElementById('search-theme-select');
            themeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>' +
                themes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        function onSearchTypeChange() {
            const searchType = document.getElementById('search-type').value;
            const searchInput = document.getElementById('search-input');
            const themeSelect = document.getElementById('search-theme-select');

            if (searchType === 'theme') {
                searchInput.style.display = 'none';
                themeSelect.style.display = 'block';
            } else {
                searchInput.style.display = 'block';
                themeSelect.style.display = 'none';
            }
        }

        async function performSearch() {
            const searchType = document.getElementById('search-type').value;
            let searchValue = '';

            if (searchType === 'theme') {
                searchValue = document.getElementById('search-theme-select').value;
                if (!searchValue) {
                    showMessage(false, '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø–æ–∏—Å–∫–∞');
                    return;
                }
                currentSearchTerm = document.getElementById('search-theme-select').selectedOptions[0].text;
            } else {
                searchValue = document.getElementById('search-input').value.trim();
                if (!searchValue) {
                    showMessage(false, '–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞');
                    return;
                }
                currentSearchTerm = searchValue;
            }

            currentSearchType = searchType;
            isSearchActive = true;
            expandedObjects.clear();
            searchResults = {};

            const loadingDiv = document.getElementById('loading');
            const listDiv = document.getElementById('objects-list');
            const searchInfo = document.getElementById('search-info');

            loadingDiv.style.display = 'block';
            loadingDiv.textContent = '–ü–æ–∏—Å–∫...';
            listDiv.innerHTML = '';

            try {
                const response = await fetch(`/api/search?type=${searchType}&value=${encodeURIComponent(searchValue)}`);
                const objects = await response.json();

                loadingDiv.style.display = 'none';

                const typeNames = {
                    'name': '–Ω–∞–∑–≤–∞–Ω–∏—é',
                    'seller_name': '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é',
                    'theme': '—Ç–µ–º–µ',
                    'bill': '–Ω–æ–º–µ—Ä—É —Å—á—ë—Ç–∞',
                    'invoice': '–Ω–æ–º–µ—Ä—É –Ω–∞–∫–ª–∞–¥–Ω–æ–π'
                };

                searchInfo.style.display = 'block';
                searchInfo.innerHTML = `–ù–∞–π–¥–µ–Ω–æ –ø–æ ${typeNames[searchType]}: <strong>${objects.length}</strong> –æ–±—ä–µ–∫—Ç–æ–≤`;

                if (objects.length === 0) {
                    listDiv.innerHTML = '<p class="no-data">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                objects.forEach(obj => {
                    searchResults[obj.id] = {
                        match_field: obj.match_field,
                        match_value: obj.match_value,
                        receipt_id: obj.receipt_id
                    };
                    expandedObjects.add(obj.id);
                });

                listDiv.innerHTML = objects.map(obj => createObjectRow(obj, true)).join('');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                for (const obj of objects) {
                    await loadObjectDetails(obj.id);
                }

            } catch (error) {
                loadingDiv.textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message;
            }
        }

        async function resetSearch() {
            isSearchActive = false;
            expandedObjects.clear();
            searchResults = {};
            currentSearchTerm = '';
            currentSearchType = '';

            document.getElementById('search-type').value = 'name';
            document.getElementById('search-input').value = '';
            document.getElementById('search-theme-select').value = '';
            document.getElementById('search-info').style.display = 'none';

            onSearchTypeChange();
            await loadObjects();
        }

        function highlightText(text, searchTerm) {
            if (!text || !searchTerm || !isSearchActive) return text;
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\$&');
        }

        function populateSelect(selectId, items, valueKey, textKey, selectedValue = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = items.map(item =>
                `<option value="${item[valueKey]}" ${item[valueKey] == selectedValue ? 'selected' : ''}>${item[textKey]}</option>`
            ).join('');
        }

        async function loadObjects() {
            const loadingDiv = document.getElementById('loading');
            const listDiv = document.getElementById('objects-list');

            try {
                const response = await fetch('/api/objects');
                const objects = await response.json();
                objectsCache = objects;

                loadingDiv.style.display = 'none';

                if (objects.length === 0) {
                    listDiv.innerHTML = '<p class="no-data">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>';
                    return;
                }

                listDiv.innerHTML = objects.map(obj => createObjectRow(obj, false)).join('');

                for (const objectId of expandedObjects) {
                    const detailsDiv = document.getElementById(`details-${objectId}`);
                    const icon = document.getElementById(`icon-${objectId}`);
                    if (detailsDiv && icon) {
                        detailsDiv.style.display = 'block';
                        icon.textContent = '‚ñº';
                        loadObjectDetails(objectId);
                    }
                }
            } catch (error) {
                loadingDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            }
        }

        function createObjectRow(obj, autoExpand = false) {
            const name = obj.objectname || obj.object_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const balanceClass = obj.balance > 0 ? 'positive' : (obj.balance < 0 ? 'negative' : 'zero');
            const isExpanded = expandedObjects.has(obj.id) || autoExpand;
            const isHighlighted = searchResults[obj.id] && searchResults[obj.id].match_field === 'object_name';

            let displayName = name;
            if (isHighlighted && currentSearchType === 'name') {
                displayName = highlightText(name, currentSearchTerm);
            }

            return `
                <div class="object-card ${isHighlighted ? 'card-highlighted' : ''}" id="object-${obj.id}">
                    <div class="object-header" onclick="toggleDetails(${obj.id})">
                        <div class="object-name">
                            <span class="expand-icon" id="icon-${obj.id}">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            ${displayName}
                        </div>
                        <div class="object-stats">
                            <span class="stat">
                                <label>–ü–æ—Å—Ç—É–ø–∏–ª–æ:</label>
                                <value>${obj.amount}</value>
                            </span>
                            <span class="stat">
                                <label>–°–ø–∏—Å–∞–Ω–æ:</label>
                                <value>${obj.write_off}</value>
                            </span>
                            <span class="stat ${balanceClass}">
                                <label>–û—Å—Ç–∞—Ç–æ–∫:</label>
                                <value>${obj.balance}</value>
                            </span>
                        </div>
                    </div>
                    <div class="object-details" id="details-${obj.id}" style="display: ${isExpanded ? 'block' : 'none'};">
                        <div class="details-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            `;
        }

        async function toggleDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);
            const icon = document.getElementById(`icon-${objectId}`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                icon.textContent = '‚ñº';
                expandedObjects.add(objectId);
                currentObjectId = objectId;
                await loadObjectDetails(objectId);
            } else {
                detailsDiv.style.display = 'none';
                icon.textContent = '‚ñ∂';
                expandedObjects.delete(objectId);
            }
        }

        async function loadObjectDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);

            try {
                const response = await fetch(`/api/object_details?id=${objectId}`);
                const details = await response.json();

                const searchInfo = searchResults[objectId] || {};
                detailsDiv.innerHTML = renderReceipts(details.receipts, searchInfo) + renderWriteoffs(details.writeoffs, searchInfo);

            } catch (error) {
                detailsDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</p>';
            }
        }

        async function refreshCurrentView() {
            const scrollPosition = window.scrollY;

            if (isSearchActive) {
                await performSearch();
            } else {
                await loadObjects();
            }
            await loadSelectorsData();

            window.scrollTo(0, scrollPosition);
        }

        function createFileLink(type, id, number, shouldHighlight = false) {
            if (!id || !number) return '-';
            let displayNumber = number;
            if (shouldHighlight) {
                displayNumber = highlightText(number, currentSearchTerm);
            }
            return `<a href="/api/file/${type}/${id}" target="_blank">${displayNumber}</a>`;
        }

        function renderReceipts(receipts, searchInfo) {
            let html = '<div class="section"><h3>üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>';

            if (receipts.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</p></div>';
            }

            html += `
                <table class="details-table">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                        <th>–¢–µ–º–∞</th>
                        <th>–°—á—ë—Ç</th>
                        <th>–î–∞—Ç–∞ —Å—á—ë—Ç–∞</th>
                        <th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>
                        <th>–î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</th>
                        <th>–í—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î–∞—Ç–∞ –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
            `;

            for (const r of receipts) {
                const isMatchedRow = searchInfo.receipt_id === r.id;
                const rowClass = isMatchedRow ? 'row-highlighted' : '';

                let sellerObjectName = r.seller_object_name || '-';
                let themeName = r.theme_name || '-';
                let billNumber = createFileLink('bill', r.bill_id, r.bill_number, 
                    currentSearchType === 'bill' && isMatchedRow);
                let invoiceNumber = createFileLink('invoice', r.invoice_id, r.invoice_number,
                    currentSearchType === 'invoice' && isMatchedRow);

                if (currentSearchType === 'seller_name' && isMatchedRow) {
                    sellerObjectName = highlightText(sellerObjectName, currentSearchTerm);
                }
                if (currentSearchType === 'theme') {
                    if (r.theme_name && r.theme_name.toLowerCase() === currentSearchTerm.toLowerCase()) {
                        themeName = `<span class="highlight">${themeName}</span>`;
                    }
                }

                html += `
                    <tr class="${rowClass}">
                        <td>${r.object_name || '-'}</td>
                        <td>${sellerObjectName}</td>
                        <td>${r.quantity}</td>
                        <td>${r.seller_name || '-'}</td>
                        <td>${themeName}</td>
                        <td>${billNumber}</td>
                        <td>${r.bill_date || '-'}</td>
                        <td>${invoiceNumber}</td>
                        <td>${r.invoice_date || '-'}</td>
                        <td>${createFileLink('entry_control', r.entry_control_id, r.entry_control_number)}</td>
                        <td>${r.entry_control_date || '-'}</td>
                        <td>${r.location || '-'}</td>
                        <td class="actions-cell">
                            <button class="btn btn-small btn-edit" onclick="editReceipt(${r.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-delete" onclick="confirmDeleteReceipt(${r.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }

            return html + '</table></div>';
        }

        function renderWriteoffs(writeoffs, searchInfo) {
            let html = '<div class="section"><h3>üì§ –°–ø–∏—Å–∞–Ω–∏—è</h3>';

            if (writeoffs.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π</p></div>';
            }

            html += `
                <table class="details-table">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
            `;

            for (const w of writeoffs) {
                let themeName = w.theme_name || '-';
                let rowClass = '';

                if (currentSearchType === 'theme') {
                    if (w.theme_name && w.theme_name.toLowerCase() === currentSearchTerm.toLowerCase()) {
                        themeName = `<span class="highlight">${themeName}</span>`;
                        rowClass = 'row-highlighted';
                    }
                }

                html += `
                    <tr class="${rowClass}">
                        <td>${w.object_name || '-'}</td>
                        <td>${w.seller_object_name || '-'}</td>
                        <td>${w.quantity}</td>
                        <td>${themeName}</td>
                        <td class="actions-cell">
                            <button class="btn btn-small btn-edit" onclick="editWriteoff(${w.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-delete" onclick="confirmDeleteWriteoff(${w.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }

            return html + '</table></div>';
        }

        async function editReceipt(id) {
            const response = await fetch(`/api/receipt?id=${id}`);
            const receipt = await response.json();

            document.getElementById('receipt-id').value = receipt.id;
            populateSelect('receipt-object-id', objectsCache, 'id', 'objectname', receipt.object_id);
            document.getElementById('receipt-seller-object-name').value = receipt.seller_object_name || '';
            document.getElementById('receipt-quantity').value = receipt.quantity;
            populateSelect('receipt-seller-id', sellersCache, 'id', 'name', receipt.seller_id);
            populateSelect('receipt-theme-id', themesCache, 'id', 'name', receipt.theme_id);
            document.getElementById('receipt-location').value = receipt.location || '';

            document.getElementById('edit-receipt-modal').classList.add('active');
        }

        async function handleReceiptSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/receipt', {
                    method: 'PUT',
                    body: formData
                });
                const result = await response.json();

                closeReceiptModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeReceiptModal() {
            document.getElementById('edit-receipt-modal').classList.remove('active');
        }

        async function editWriteoff(id) {
            const response = await fetch(`/api/writeoff?id=${id}`);
            const writeoff = await response.json();

            document.getElementById('writeoff-id').value = writeoff.id;
            populateSelect('writeoff-object-id', objectsCache, 'id', 'objectname', writeoff.object_id);
            document.getElementById('writeoff-quantity').value = writeoff.quantity;
            populateSelect('writeoff-theme-id', themesCache, 'id', 'name', writeoff.theme_id);

            document.getElementById('edit-writeoff-modal').classList.add('active');
        }

        async function handleWriteoffSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/writeoff', {
                    method: 'PUT',
                    body: formData
                });
                const result = await response.json();

                closeWriteoffModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeWriteoffModal() {
            document.getElementById('edit-writeoff-modal').classList.remove('active');
        }

        function confirmDeleteReceipt(id) {
            currentDeleteType = 'receipt';
            currentDeleteId = id;
            document.getElementById('delete-message').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ?';
            document.getElementById('confirm-delete-btn').onclick = executeDelete;
            document.getElementById('delete-modal').classList.add('active');
        }

        function confirmDeleteWriteoff(id) {
            currentDeleteType = 'writeoff';
            currentDeleteId = id;
            document.getElementById('delete-message').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–ø–∏—Å–∞–Ω–∏–µ?';
            document.getElementById('confirm-delete-btn').onclick = executeDelete;
            document.getElementById('delete-modal').classList.add('active');
        }

        async function executeDelete() {
            try {
                const response = await fetch(`/api/${currentDeleteType}?id=${currentDeleteId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                closeDeleteModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
        }

        function showMessage(success, title, message) {
            document.getElementById('message-icon').textContent = success ? '‚úì' : '‚úó';
            document.getElementById('message-icon').className = 'modal-icon ' + (success ? 'success' : 'error');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-modal').classList.add('active');
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.remove('active');
        }

        async function checkAuth() {
    try {
        const response = await fetch('/api/auth/check');
        const data = await response.json();

        if (data.authenticated) {
            currentUser = data.user;
            showUserInfo();
        } else {
            currentUser = null;
            showLoginPrompt();
        }
        updateUIForAuth();
    } catch (error) {
        console.error('Auth check failed:', error);
    }
}

        function showUserInfo() {
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('login-prompt').style.display = 'none';
            document.getElementById('user-name').textContent = `üë§ ${currentUser.username}${currentUser.admin ? ' (–∞–¥–º–∏–Ω)' : ''}`;
        }

        function showLoginPrompt() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('login-prompt').style.display = 'flex';
        }

        function updateUIForAuth() {
            const addBtn = document.querySelector('a[href="/add"]');
            const manageBtn = document.querySelector('a[href="/manage"]');
            const headerButtons = document.querySelector('.header-buttons');

            if (currentUser) {
                if (addBtn) addBtn.style.display = 'inline-block';
                if (manageBtn) manageBtn.style.display = 'inline-block';

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
                if (currentUser.admin) {
                    let usersBtn = document.querySelector('a[href="/users"]');
                    if (!usersBtn && headerButtons) {
                        usersBtn = document.createElement('a');
                        usersBtn.href = '/users';
                        usersBtn.className = 'btn btn-secondary';
                        usersBtn.textContent = 'üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
                        headerButtons.appendChild(usersBtn);
                    }
                }
            } else {
                if (addBtn) addBtn.style.display = 'none';
                if (manageBtn) manageBtn.style.display = 'none';
                const usersBtn = document.querySelector('a[href="/users"]');
                if (usersBtn) usersBtn.remove();
            }

            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
            document.querySelectorAll('.actions-cell').forEach(cell => {
                cell.style.display = currentUser ? '' : 'none';
            });
        }

        function showLoginModal() {
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('login-username').focus();
        }

        function closeLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    document.getElementById('login-error').textContent = result.error;
                    document.getElementById('login-error').style.display = 'block';
                } else {
                    closeLoginModal();
                    currentUser = result.user;
                    showUserInfo();
                    updateUIForAuth();
                    showMessage(true, '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${result.user.username}`);
                }
            } catch (error) {
                document.getElementById('login-error').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                document.getElementById('login-error').style.display = 'block';
            }
        });

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;
                showLoginPrompt();
                updateUIForAuth();
                showMessage(true, '–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!', '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>