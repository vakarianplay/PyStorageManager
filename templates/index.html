<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>üì¶ –°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤</h1>
            <div class="header-buttons">
                <a href="/add" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å</a>
                <a href="/manage" class="btn btn-secondary">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
            </div>
        </div>
        <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="objects-list"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
    <div id="edit-receipt-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>
            <form id="edit-receipt-form">
                <input type="hidden" id="receipt-id" name="id">
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <select id="receipt-object-id" name="objectId" required></select>
                </div>
                <div class="form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</label>
                    <input type="text" id="receipt-seller-object-name" name="sellerObjectName" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="receipt-quantity" name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select id="receipt-seller-id" name="sellerId" required></select>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞</label>
                    <select id="receipt-theme-id" name="themeId" required></select>
                </div>
                <div class="form-group">
                    <label>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                    <input type="text" id="receipt-location" name="location">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReceiptModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div id="edit-writeoff-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è</h3>
            <form id="edit-writeoff-form">
                <input type="hidden" id="writeoff-id" name="id">
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <select id="writeoff-object-id" name="objectId" required></select>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="writeoff-quantity" name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
                    <select id="writeoff-theme-id" name="themeId" required></select>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeWriteoffModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon error">!</div>
            <div class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</div>
            <div class="modal-message" id="delete-message"></div>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="confirm-delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon" id="message-icon">‚úì</div>
            <div class="modal-title" id="message-title">–£—Å–ø–µ—à–Ω–æ!</div>
            <div class="modal-message" id="message-text"></div>
            <button class="btn btn-primary modal-btn" onclick="closeMessageModal()">OK</button>
        </div>
    </div>

    <script>
        let objectsCache = [];
        let sellersCache = [];
        let themesCache = [];
        let currentDeleteType = '';
        let currentDeleteId = null;
        let currentObjectId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadObjects();
            loadSelectorsData();
            document.getElementById('edit-receipt-form').addEventListener('submit', handleReceiptSubmit);
            document.getElementById('edit-writeoff-form').addEventListener('submit', handleWriteoffSubmit);
        });

        async function loadSelectorsData() {
            const [objects, sellers, themes] = await Promise.all([
                fetch('/api/objects').then(r => r.json()),
                fetch('/api/sellers').then(r => r.json()),
                fetch('/api/themes').then(r => r.json())
            ]);
            objectsCache = objects;
            sellersCache = sellers;
            themesCache = themes;
        }

        function populateSelect(selectId, items, valueKey, textKey, selectedValue = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = items.map(item => 
                `<option value="${item[valueKey]}" ${item[valueKey] == selectedValue ? 'selected' : ''}>${item[textKey]}</option>`
            ).join('');
        }

        async function loadObjects() {
            const loadingDiv = document.getElementById('loading');
            const listDiv = document.getElementById('objects-list');

            try {
                const response = await fetch('/api/objects');
                const objects = await response.json();

                loadingDiv.style.display = 'none';

                if (objects.length === 0) {
                    listDiv.innerHTML = '<p class="no-data">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>';
                    return;
                }

                listDiv.innerHTML = objects.map(createObjectRow).join('');
            } catch (error) {
                loadingDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            }
        }

        function createObjectRow(obj) {
            const name = obj.objectname || obj.object_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const balanceClass = obj.balance > 0 ? 'positive' : (obj.balance < 0 ? 'negative' : 'zero');

            return `
                <div class="object-card" id="object-${obj.id}">
                    <div class="object-header" onclick="toggleDetails(${obj.id})">
                        <div class="object-name">
                            <span class="expand-icon" id="icon-${obj.id}">‚ñ∂</span>
                            ${name}
                        </div>
                        <div class="object-stats">
                            <span class="stat">
                                <label>–ü–æ—Å—Ç—É–ø–∏–ª–æ:</label>
                                <value>${obj.amount}</value>
                            </span>
                            <span class="stat">
                                <label>–°–ø–∏—Å–∞–Ω–æ:</label>
                                <value>${obj.write_off}</value>
                            </span>
                            <span class="stat ${balanceClass}">
                                <label>–û—Å—Ç–∞—Ç–æ–∫:</label>
                                <value>${obj.balance}</value>
                            </span>
                        </div>
                    </div>
                    <div class="object-details" id="details-${obj.id}" style="display: none;">
                        <div class="details-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            `;
        }

        async function toggleDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);
            const icon = document.getElementById(`icon-${objectId}`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                icon.textContent = '‚ñº';
                currentObjectId = objectId;
                await loadObjectDetails(objectId);
            } else {
                detailsDiv.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        async function loadObjectDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);

            try {
                const response = await fetch(`/api/object_details?id=${objectId}`);
                const details = await response.json();

                detailsDiv.innerHTML = renderReceipts(details.receipts) + renderWriteoffs(details.writeoffs);
            } catch (error) {
                detailsDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</p>';
            }
        }

        function createFileLink(type, id, number) {
            if (!id || !number) return '-';
            return `<a href="/api/file/${type}/${id}" target="_blank">${number}</a>`;
        }

        function renderReceipts(receipts) {
            let html = '<div class="section"><h3>üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>';

            if (receipts.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</p></div>';
            }

            html += `
                <table class="details-table">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                        <th>–¢–µ–º–∞</th>
                        <th>–°—á—ë—Ç</th>
                        <th>–î–∞—Ç–∞ —Å—á—ë—Ç–∞</th>
                        <th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>
                        <th>–î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</th>
                        <th>–í—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î–∞—Ç–∞ –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
            `;

            for (const r of receipts) {
                html += `
                    <tr>
                        <td>${r.object_name || '-'}</td>
                        <td>${r.seller_object_name || '-'}</td>
                        <td>${r.quantity}</td>
                        <td>${r.seller_name || '-'}</td>
                        <td>${r.theme_name || '-'}</td>
                        <td>${createFileLink('bill', r.bill_id, r.bill_number)}</td>
                        <td>${r.bill_date || '-'}</td>
                        <td>${createFileLink('invoice', r.invoice_id, r.invoice_number)}</td>
                        <td>${r.invoice_date || '-'}</td>
                        <td>${createFileLink('entry_control', r.entry_control_id, r.entry_control_number)}</td>
                        <td>${r.entry_control_date || '-'}</td>
                        <td>${r.location || '-'}</td>
                        <td>
                            <button class="btn btn-small btn-edit" onclick="editReceipt(${r.id})">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-delete" onclick="confirmDeleteReceipt(${r.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }

            return html + '</table></div>';
        }

        function renderWriteoffs(writeoffs) {
            let html = '<div class="section"><h3>üì§ –°–ø–∏—Å–∞–Ω–∏—è</h3>';

            if (writeoffs.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π</p></div>';
            }

            html += `
                <table class="details-table">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
            `;

            for (const w of writeoffs) {
                html += `
                    <tr>
                        <td>${w.object_name || '-'}</td>
                        <td>${w.seller_object_name || '-'}</td>
                        <td>${w.quantity}</td>
                        <td>${w.theme_name || '-'}</td>
                        <td>
                            <button class="btn btn-small btn-edit" onclick="editWriteoff(${w.id})">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-delete" onclick="confirmDeleteWriteoff(${w.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }

            return html + '</table></div>';
        }

        async function editReceipt(id) {
            const response = await fetch(`/api/receipt?id=${id}`);
            const receipt = await response.json();

            document.getElementById('receipt-id').value = receipt.id;
            populateSelect('receipt-object-id', objectsCache, 'id', 'objectname', receipt.object_id);
            document.getElementById('receipt-seller-object-name').value = receipt.seller_object_name || '';
            document.getElementById('receipt-quantity').value = receipt.quantity;
            populateSelect('receipt-seller-id', sellersCache, 'id', 'name', receipt.seller_id);
            populateSelect('receipt-theme-id', themesCache, 'id', 'name', receipt.theme_id);
            document.getElementById('receipt-location').value = receipt.location || '';

            document.getElementById('edit-receipt-modal').classList.add('active');
        }

        async function handleReceiptSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/receipt', {
                    method: 'PUT',
                    body: formData
                });
                const result = await response.json();

                closeReceiptModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    loadObjects();
                    if (currentObjectId) {
                        setTimeout(() => loadObjectDetails(currentObjectId), 100);
                    }
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeReceiptModal() {
            document.getElementById('edit-receipt-modal').classList.remove('active');
        }

        async function editWriteoff(id) {
            const response = await fetch(`/api/writeoff?id=${id}`);
            const writeoff = await response.json();

            document.getElementById('writeoff-id').value = writeoff.id;
            populateSelect('writeoff-object-id', objectsCache, 'id', 'objectname', writeoff.object_id);
            document.getElementById('writeoff-quantity').value = writeoff.quantity;
            populateSelect('writeoff-theme-id', themesCache, 'id', 'name', writeoff.theme_id);

            document.getElementById('edit-writeoff-modal').classList.add('active');
        }

        async function handleWriteoffSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/writeoff', {
                    method: 'PUT',
                    body: formData
                });
                const result = await response.json();

                closeWriteoffModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    loadObjects();
                    if (currentObjectId) {
                        setTimeout(() => loadObjectDetails(currentObjectId), 100);
                    }
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeWriteoffModal() {
            document.getElementById('edit-writeoff-modal').classList.remove('active');
        }

        function confirmDeleteReceipt(id) {
            currentDeleteType = 'receipt';
            currentDeleteId = id;
            document.getElementById('delete-message').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ?';
            document.getElementById('confirm-delete-btn').onclick = executeDelete;
            document.getElementById('delete-modal').classList.add('active');
        }

        function confirmDeleteWriteoff(id) {
            currentDeleteType = 'writeoff';
            currentDeleteId = id;
            document.getElementById('delete-message').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–ø–∏—Å–∞–Ω–∏–µ?';
            document.getElementById('confirm-delete-btn').onclick = executeDelete;
            document.getElementById('delete-modal').classList.add('active');
        }

        async function executeDelete() {
            try {
                const response = await fetch(`/api/${currentDeleteType}?id=${currentDeleteId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                closeDeleteModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    loadObjects();
                    if (currentObjectId) {
                        setTimeout(() => loadObjectDetails(currentObjectId), 100);
                    }
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
        }

        function showMessage(success, title, message) {
            document.getElementById('message-icon').textContent = success ? '‚úì' : '‚úó';
            document.getElementById('message-icon').className = 'modal-icon ' + (success ? 'success' : 'error');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-modal').classList.add('active');
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.remove('active');
        }
    </script>
</body>
</html>