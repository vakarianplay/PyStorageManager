<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">–°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" id="favicon">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1 id="main-title">
                <span class="title-logo" id="title-logo">üì¶</span>
                <span id="title-text">–°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤</span>
            </h1>
            <div class="header-buttons">
                <a href="/add" class="btn btn-primary auth-required" style="display: none;">+ –î–æ–±–∞–≤–∏—Ç—å</a>
                <a href="/manage" class="btn btn-secondary auth-required" style="display: none;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
                <a href="/users" class="btn btn-secondary admin-required" style="display: none;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                <button class="btn btn-outline" id="auth-btn" onclick="showLoginModal()">üîê –í–æ–π—Ç–∏</button>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –ø–æ–∏—Å–∫–∞ -->
        <div class="search-panel">
            <div class="search-row">
                <select id="search-type" class="search-select" onchange="onSearchTypeChange()">
                    <option value="name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –ö–î</option>
                    <option value="seller_name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</option>
                    <option value="theme">–¢–µ–º–∞</option>
                    <option value="bill">–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞</option>
                    <option value="invoice">–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π</option>
                </select>
                <input type="text" id="search-input" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                <select id="search-theme-select" class="search-select" style="display: none;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>
                </select>
                <button class="btn btn-primary" onclick="performSearch()">üîç –ü–æ–∏—Å–∫</button>
                <button class="btn btn-secondary" onclick="resetSearch()">‚úñ –°–±—Ä–æ—Å</button>
            </div>
            <div id="search-info" class="search-info" style="display: none;"></div>
        </div>

        <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="objects-list"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <form id="login-form">
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="login-username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" name="password" required autocomplete="current-password">
                </div>
                <div id="login-error" class="error-message" style="display: none;"></div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLoginModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
    <div id="edit-receipt-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>
            <form id="edit-receipt-form">
                <input type="hidden" id="receipt-id" name="id">
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <select id="receipt-object-id" name="objectId" required></select>
                </div>
                <div class="form-group">
                    <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</label>
                    <input type="text" id="receipt-seller-object-name" name="sellerObjectName" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="receipt-quantity" name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select id="receipt-seller-id" name="sellerId" required></select>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞</label>
                    <select id="receipt-theme-id" name="themeId" required></select>
                </div>
                <div class="form-group">
                    <label>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                    <input type="text" id="receipt-location" name="location">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReceiptModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div id="edit-writeoff-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è</h3>
            <form id="edit-writeoff-form">
                <input type="hidden" id="writeoff-id" name="id">
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç</label>
                    <select id="writeoff-object-id" name="objectId"
                            required></select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
                    <input type="date" id="writeoff-date"
                        name="writeoffDate" required>
                </div>
                <div class="form-group">
                    <label>–î–æ–∫—É–º–µ–Ω—Ç</label>
                    <input type="file" id="writeoff-document"
                        name="writeoffDocument"
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                    <small id="writeoff-doc-info"
                        style="color: #666;"></small>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="writeoff-quantity"
                        name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
                    <select id="writeoff-theme-id" name="themeId"
                            required></select>
                </div>
                <div class="modal-buttons">
                    <button type="submit"
                            class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary"
                            onclick="closeWriteoffModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã -->
    <div id="pricing-modal" class="modal-overlay">
        <div class="modal modal-edit">
            <h3 id="pricing-modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É</h3>
            <form id="pricing-form">
                <input type="hidden" id="pricing-id" name="id">
                <input type="hidden" id="pricing-receipt-id" name="receiptId">
                <div class="form-group">
                    <label>–¶–µ–Ω–∞ –∑–∞ —à—Ç. –±–µ–∑ –ù–î–° (‚ÇΩ)</label>
                    <input type="number" id="pricing-price" name="price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>–°—Ç–∞–≤–∫–∞ –ù–î–° (%)</label>
                    <select id="pricing-tax" name="tax" required>
                        <option value="0">0%</option>
                        <option value="10">10%</option>
                        <option value="20">20%</option>
                        <option value="22" selected>22%</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closePricingModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon error">!</div>
            <div class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</div>
            <div class="modal-message" id="delete-message"></div>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="confirm-delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-icon" id="message-icon">‚úì</div>
            <div class="modal-title" id="message-title">–£—Å–ø–µ—à–Ω–æ!</div>
            <div class="modal-message" id="message-text"></div>
            <button class="btn btn-primary modal-btn" onclick="closeMessageModal()">OK</button>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let objectsCache = [];
        let sellersCache = [];
        let themesCache = [];
        let currentDeleteType = '';
        let currentDeleteId = null;
        let currentObjectId = null;
        let expandedObjects = new Set();
        let isSearchActive = false;
        let searchResults = {};
        let currentSearchTerm = '';
        let currentSearchType = '';
        let currentUser = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            checkAuth();
            loadObjects();
            loadSelectorsData();

            document.getElementById('edit-receipt-form').addEventListener('submit', handleReceiptSubmit);
            document.getElementById('edit-writeoff-form').addEventListener('submit', handleWriteoffSubmit);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('pricing-form').addEventListener('submit', handlePricingSubmit);

            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
        });

        // ==================== CONFIG ====================
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                if (config.company_name) {
                    document.getElementById('title-text').textContent = `–°–∫–ª–∞–¥ - ${config.company_name}`;
                    document.getElementById('page-title').textContent = `–°–∫–ª–∞–¥ - ${config.company_name}`;
                }

                if (config.has_logo) {
                    const logoImg = document.createElement('img');
                    logoImg.src = '/static/logo';
                    logoImg.alt = 'Logo';
                    logoImg.className = 'header-logo';

                    const titleLogo = document.getElementById('title-logo');
                    titleLogo.innerHTML = '';
                    titleLogo.appendChild(logoImg);

                    const favicon = document.getElementById('favicon');
                    favicon.href = '/static/logo';
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // ==================== AUTH ====================
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();

                if (data.authenticated) {
                    currentUser = data.user;
                } else {
                    currentUser = null;
                }
                updateUIForAuth();
            } catch (error) {
                console.error('Auth check failed:', error);
                currentUser = null;
                updateUIForAuth();
            }
        }

        function updateUIForAuth() {
            const authBtn = document.getElementById('auth-btn');
            const authRequiredElements = document.querySelectorAll('.auth-required');
            const adminRequiredElements = document.querySelectorAll('.admin-required');

            if (currentUser) {
                authBtn.textContent = `üë§ ${currentUser.username}`;
                authBtn.onclick = showUserMenu;
                authBtn.classList.add('btn-logged-in');

                authRequiredElements.forEach(el => el.style.display = 'inline-block');

                if (currentUser.admin) {
                    adminRequiredElements.forEach(el => el.style.display = 'inline-block');
                } else {
                    adminRequiredElements.forEach(el => el.style.display = 'none');
                }
            } else {
                authBtn.textContent = 'üîê –í–æ–π—Ç–∏';
                authBtn.onclick = showLoginModal;
                authBtn.classList.remove('btn-logged-in');

                authRequiredElements.forEach(el => el.style.display = 'none');
                adminRequiredElements.forEach(el => el.style.display = 'none');
            }
        }

        function showLoginModal() {
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('login-username').focus();
        }

        function closeLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.error) {
                    document.getElementById('login-error').textContent = result.error;
                    document.getElementById('login-error').style.display = 'block';
                } else {
                    closeLoginModal();
                    currentUser = result.user;
                    updateUIForAuth();
                    refreshCurrentView();
                    showMessage(true, '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${result.user.username}`);
                }
            } catch (error) {
                document.getElementById('login-error').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function showUserMenu() {
            if (confirm(`–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ ${currentUser.username}?`)) {
                logout();
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;
                updateUIForAuth();
                refreshCurrentView();
                showMessage(true, '–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!', '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        // ==================== DATA LOADING ====================
        async function loadSelectorsData() {
            try {
                const [objects, sellers, themes] = await Promise.all([
                    fetch('/api/objects').then(r => r.json()),
                    fetch('/api/sellers').then(r => r.json()),
                    fetch('/api/themes').then(r => r.json())
                ]);
                objectsCache = objects;
                sellersCache = sellers;
                themesCache = themes;

                const themeSelect = document.getElementById('search-theme-select');
                themeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>' +
                    themes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            } catch (error) {
                console.error('Failed to load selectors:', error);
            }
        }

        async function loadObjects() {
            const loadingDiv = document.getElementById('loading');
            const listDiv = document.getElementById('objects-list');

            try {
                const response = await fetch('/api/objects');
                const objects = await response.json();
                objectsCache = objects;

                loadingDiv.style.display = 'none';

                if (objects.length === 0) {
                    listDiv.innerHTML = '<p class="no-data">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>';
                    return;
                }

                listDiv.innerHTML = objects.map(obj => createObjectRow(obj, false)).join('');

                for (const objectId of expandedObjects) {
                    const detailsDiv = document.getElementById(`details-${objectId}`);
                    const icon = document.getElementById(`icon-${objectId}`);
                    if (detailsDiv && icon) {
                        detailsDiv.style.display = 'block';
                        icon.textContent = '‚ñº';
                        loadObjectDetails(objectId);
                    }
                }
            } catch (error) {
                loadingDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            }
        }

        async function loadObjectDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);

            try {
                const response = await fetch(`/api/object_details?id=${objectId}`);
                const details = await response.json();

                const searchInfo = searchResults[objectId] || {};
                detailsDiv.innerHTML = renderReceipts(details.receipts, searchInfo) + renderWriteoffs(details.writeoffs, searchInfo);
            } catch (error) {
                detailsDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</p>';
            }
        }

        async function refreshCurrentView() {
            const scrollPosition = window.scrollY;

            if (isSearchActive) {
                await performSearch();
            } else {
                await loadObjects();
            }
            await loadSelectorsData();

            window.scrollTo(0, scrollPosition);
        }

        // ==================== SEARCH ====================
        function onSearchTypeChange() {
            const searchType = document.getElementById('search-type').value;
            const searchInput = document.getElementById('search-input');
            const themeSelect = document.getElementById('search-theme-select');

            if (searchType === 'theme') {
                searchInput.style.display = 'none';
                themeSelect.style.display = 'block';
            } else {
                searchInput.style.display = 'block';
                themeSelect.style.display = 'none';
            }
        }

        async function performSearch() {
            const searchType = document.getElementById('search-type').value;
            let searchValue = '';

            if (searchType === 'theme') {
                searchValue = document.getElementById('search-theme-select').value;
                if (!searchValue) {
                    showMessage(false, '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø–æ–∏—Å–∫–∞');
                    return;
                }
                currentSearchTerm = document.getElementById('search-theme-select').selectedOptions[0].text;
            } else {
                searchValue = document.getElementById('search-input').value.trim();
                if (!searchValue) {
                    showMessage(false, '–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞');
                    return;
                }
                currentSearchTerm = searchValue;
            }

            currentSearchType = searchType;
            isSearchActive = true;
            expandedObjects.clear();
            searchResults = {};

            const loadingDiv = document.getElementById('loading');
            const listDiv = document.getElementById('objects-list');
            const searchInfo = document.getElementById('search-info');

            loadingDiv.style.display = 'block';
            loadingDiv.textContent = '–ü–æ–∏—Å–∫...';
            listDiv.innerHTML = '';

            try {
                const response = await fetch(`/api/search?type=${searchType}&value=${encodeURIComponent(searchValue)}`);
                const objects = await response.json();

                loadingDiv.style.display = 'none';

                const typeNames = {
                    'name': '–Ω–∞–∑–≤–∞–Ω–∏—é',
                    'seller_name': '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é',
                    'theme': '—Ç–µ–º–µ',
                    'bill': '–Ω–æ–º–µ—Ä—É —Å—á—ë—Ç–∞',
                    'invoice': '–Ω–æ–º–µ—Ä—É –Ω–∞–∫–ª–∞–¥–Ω–æ–π'
                };

                searchInfo.style.display = 'block';
                searchInfo.innerHTML = `–ù–∞–π–¥–µ–Ω–æ –ø–æ ${typeNames[searchType]}: <strong>${objects.length}</strong> –æ–±—ä–µ–∫—Ç–æ–≤`;

                if (objects.length === 0) {
                    listDiv.innerHTML = '<p class="no-data">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }

                objects.forEach(obj => {
                    searchResults[obj.id] = {
                        match_field: obj.match_field,
                        match_value: obj.match_value,
                        receipt_id: obj.receipt_id
                    };
                    expandedObjects.add(obj.id);
                });

                listDiv.innerHTML = objects.map(obj => createObjectRow(obj, true)).join('');

                for (const obj of objects) {
                    await loadObjectDetails(obj.id);
                }
            } catch (error) {
                loadingDiv.textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message;
            }
        }

        async function resetSearch() {
            isSearchActive = false;
            expandedObjects.clear();
            searchResults = {};
            currentSearchTerm = '';
            currentSearchType = '';

            document.getElementById('search-type').value = 'name';
            document.getElementById('search-input').value = '';
            document.getElementById('search-theme-select').value = '';
            document.getElementById('search-info').style.display = 'none';

            onSearchTypeChange();
            await loadObjects();
        }

        // ==================== RENDER FUNCTIONS ====================
        function createObjectRow(obj, autoExpand = false) {
            const name = obj.objectname || obj.object_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const balanceClass = obj.balance > 0 ? 'positive' : (obj.balance < 0 ? 'negative' : 'zero');
            const isExpanded = expandedObjects.has(obj.id) || autoExpand;
            const isHighlighted = searchResults[obj.id] && searchResults[obj.id].match_field === 'object_name';

            let displayName = name;
            if (isHighlighted && currentSearchType === 'name') {
                displayName = highlightText(name, currentSearchTerm);
            }

            return `
                <div class="object-card ${isHighlighted ? 'card-highlighted' : ''}" id="object-${obj.id}">
                    <div class="object-header" onclick="toggleDetails(${obj.id})">
                        <div class="object-name">
                            <span class="expand-icon" id="icon-${obj.id}">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            ${displayName}
                        </div>
                        <div class="object-stats">
                            <span class="stat">
                                <label>–ü–æ—Å—Ç—É–ø–∏–ª–æ:</label>
                                <value>${obj.amount}</value>
                            </span>
                            <span class="stat">
                                <label>–°–ø–∏—Å–∞–Ω–æ:</label>
                                <value>${obj.write_off}</value>
                            </span>
                            <span class="stat ${balanceClass}">
                                <label>–û—Å—Ç–∞—Ç–æ–∫:</label>
                                <value>${obj.balance}</value>
                            </span>
                        </div>
                    </div>
                    <div class="object-details" id="details-${obj.id}" style="display: ${isExpanded ? 'block' : 'none'};">
                        <div class="details-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            `;
        }

        function renderReceipts(receipts, searchInfo) {
            let html = '<div class="section"><h3>üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>';

            if (receipts.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</p></div>';
            }

            const showActions = currentUser !== null;
            const actionsHeader = showActions ? '<th>–î–µ–π—Å—Ç–≤–∏—è</th>' : '';

            html += `
                <table class="details-table receipts-table">
                    <thead>
                        <tr>
                            <th class="col-expand"></th>
                            <!-- <th>–ù–∞–∏–º. –ø–æ –ö–î</th> -->
                            <th>–ù–∞–∏–º. –ø–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</th>
                            <th>–ö–æ–ª-–≤–æ</th>
                            <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            <th>–¢–µ–º–∞</th>
                            <th>–°—á—ë—Ç</th>
                            <th>–î–∞—Ç–∞ —Å—á—ë—Ç–∞</th>
                            <th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>
                            <th>–î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</th>
                            <th>–í—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—å</th>
                            <th>–î–∞—Ç–∞ –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</th>
                            <th>–ú–µ—Å—Ç–æ</th>
                            ${actionsHeader}
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const r of receipts) {
                const isMatchedRow = searchInfo.receipt_id === r.id;
                const rowClass = isMatchedRow ? 'row-highlighted' : '';

                let sellerObjectName = r.seller_object_name || '-';
                let themeName = r.theme_name || '-';
                let billNumber = createFileLink('bill', r.bill_id, r.bill_number,
                    currentSearchType === 'bill' && isMatchedRow);
                let invoiceNumber = createFileLink('invoice', r.invoice_id, r.invoice_number,
                    currentSearchType === 'invoice' && isMatchedRow);

                if (currentSearchType === 'seller_name' && isMatchedRow) {
                    sellerObjectName = highlightText(sellerObjectName, currentSearchTerm);
                }
                if (currentSearchType === 'theme') {
                    if (r.theme_name && r.theme_name.toLowerCase() === currentSearchTerm.toLowerCase()) {
                        themeName = `<span class="highlight">${themeName}</span>`;
                    }
                }

                const hasPrice = r.price !== null && r.price !== undefined;
                const expandIcon = hasPrice ? '<span class="price-indicator">üî∂</span>' : '';
                const rowClickable = hasPrice ? 'clickable-row' : '';

                const actionsCell = showActions ? `
                    <td class="actions-cell">
                        <button class="btn btn-small btn-edit" onclick="event.stopPropagation(); editReceipt(${r.id});" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button class="btn btn-small ${hasPrice ? 'btn-price-edit' : 'btn-price-add'}" 
                                onclick="event.stopPropagation(); ${hasPrice ? `editPricing(${r.id})` : `addPricing(${r.id})`};" 
                                title="${hasPrice ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É' : '–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É'}">üí∞</button>
                        <button class="btn btn-small btn-delete" onclick="event.stopPropagation(); confirmDeleteReceipt(${r.id});" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </td>
                ` : '';

                const rowOnClick = hasPrice ? `onclick="togglePricingRow(${r.id})"` : '';

                html += `
                    <tr class="${rowClass} ${rowClickable}" ${rowOnClick}>
                        <td class="col-expand">${expandIcon}</td>
                        <!-- <td>${r.object_name || '-'}</td> -->
                        <td>${sellerObjectName}</td>
                        <td>${r.quantity}</td>
                        <td>${r.seller_name || '-'}</td>
                        <td>${themeName}</td>
                        <td>${billNumber}</td>
                        <td>${r.bill_date || '-'}</td>
                        <td>${invoiceNumber}</td>
                        <td>${r.invoice_date || '-'}</td>
                        <td>${createFileLink('entry_control', r.entry_control_id, r.entry_control_number)}</td>
                        <td>${r.entry_control_date || '-'}</td>
                        <td>${r.location || '-'}</td>
                        ${actionsCell}
                    </tr>
                `;

                if (hasPrice) {
                    const colSpan = showActions ? 14 : 13;
                    const priceWithTax = formatCurrency(r.price_with_tax);
                    const totalPrice = formatCurrency(r.total_price);
                    const totalPriceWithTax = formatCurrency(r.total_price_with_tax);

                    html += `
                        <tr class="pricing-row" id="pricing-row-${r.id}" style="display: none;">
                            <td colspan="${colSpan}">
                                <div class="pricing-details">
                                    <div class="pricing-grid">
                                        <div class="pricing-item">
                                            <span class="pricing-label">–¶–µ–Ω–∞ –∑–∞ —à—Ç. (–±–µ–∑ –ù–î–°)</span>
                                            <span class="pricing-value">${formatCurrency(r.price)}</span>
                                        </div>
                                        <div class="pricing-item">
                                            <span class="pricing-label">–ù–î–°</span>
                                            <span class="pricing-value">${r.tax}%</span>
                                        </div>
                                        <div class="pricing-item">
                                            <span class="pricing-label">–¶–µ–Ω–∞ —Å –ù–î–°</span>
                                            <span class="pricing-value">${priceWithTax}</span>
                                        </div>
                                        <div class="pricing-item">
                                            <span class="pricing-label">–°—É–º–º–∞ –±–µ–∑ –ù–î–°</span>
                                            <span class="pricing-value">${totalPrice}</span>
                                        </div>
                                        <div class="pricing-item highlight-total">
                                            <span class="pricing-label">–ò—Ç–æ–≥–æ —Å –ù–î–°</span>
                                            <span class="pricing-value">${totalPriceWithTax}</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }

            html += '</tbody></table></div>';
            return html;
        }

        function renderWriteoffs(writeoffs, searchInfo) {
            let html = '<div class="section"><h3>üì§ –°–ø–∏—Å–∞–Ω–∏—è</h3>';

            if (writeoffs.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π</p></div>';
            }

            const showActions = currentUser !== null;
            const actionsHeader = showActions ? '<th>–î–µ–π—Å—Ç–≤–∏—è</th>' : '';

            html += `
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–æ–∫—É–º–µ–Ω—Ç</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</th>
                            ${actionsHeader}
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const w of writeoffs) {
                let themeName = w.theme_name || '-';
                let rowClass = '';

                if (currentSearchType === 'theme') {
                    if (w.theme_name &&
                        w.theme_name.toLowerCase() ===
                        currentSearchTerm.toLowerCase()) {
                        themeName =
                            `<span class="highlight">${themeName}</span>`;
                        rowClass = 'row-highlighted';
                    }
                }

                const dateDisplay = w.writeoff_date || '-';

                let documentDisplay = '-';
                    if (w.has_document && w.document_filename) {
                        documentDisplay =
                            `<a href="/api/file/writeoff/${w.id}" ` +
                            `target="_blank" ` +
                            `onclick="event.stopPropagation();">` +
                            `${w.document_filename}</a>`;
                    }

                const actionsCell = showActions ? `
                    <td class="actions-cell">
                        <button class="btn btn-small btn-edit"
                            onclick="editWriteoff(${w.id})"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button class="btn btn-small btn-delete"
                            onclick="confirmDeleteWriteoff(${w.id})"
                            title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </td>
                ` : '';

                html += `
                    <tr class="${rowClass}">
                        <td>${dateDisplay}</td>
                        <td>${documentDisplay}</td>
                        <td>${w.quantity}</td>
                        <td>${themeName}</td>
                        ${actionsCell}
                    </tr>
                `;
            }

            html += '</tbody></table></div>';
            return html;
        }

        // ==================== HELPERS ====================
        function toggleDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);
            const icon = document.getElementById(`icon-${objectId}`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                icon.textContent = '‚ñº';
                expandedObjects.add(objectId);
                currentObjectId = objectId;
                loadObjectDetails(objectId);
            } else {
                detailsDiv.style.display = 'none';
                icon.textContent = '‚ñ∂';
                expandedObjects.delete(objectId);
            }
        }

        function togglePricingRow(receiptId) {
            const pricingRow = document.getElementById(`pricing-row-${receiptId}`);
            if (!pricingRow) return;

            const isVisible = pricingRow.style.display !== 'none';

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å —Ü–µ–Ω–∞–º–∏
            document.querySelectorAll('.pricing-row').forEach(row => {
                row.style.display = 'none';
            });

            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
            if (!isVisible) {
                pricingRow.style.display = 'table-row';
            }
        }

        function createFileLink(type, id, number, shouldHighlight = false) {
            if (!id || !number) return '-';
            let displayNumber = number;
            if (shouldHighlight) {
                displayNumber = highlightText(number, currentSearchTerm);
            }
            return `<a href="/api/file/${type}/${id}" target="_blank" onclick="event.stopPropagation();">${displayNumber}</a>`;
        }

        function highlightText(text, searchTerm) {
            if (!text || !searchTerm || !isSearchActive) return text;
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\$&');
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB'
            }).format(value);
        }

        function populateSelect(selectId, items, valueKey, textKey, selectedValue = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = items.map(item =>
                `<option value="${item[valueKey]}" ${item[valueKey] == selectedValue ? 'selected' : ''}>${item[textKey]}</option>`
            ).join('');
        }

        // ==================== RECEIPT CRUD ====================
        async function editReceipt(id) {
            if (!currentUser) {
                showMessage(false, '–û—à–∏–±–∫–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            try {
                const response = await fetch(`/api/receipt?id=${id}`);
                const receipt = await response.json();

                document.getElementById('receipt-id').value = receipt.id;
                populateSelect('receipt-object-id', objectsCache, 'id', 'objectname', receipt.object_id);
                document.getElementById('receipt-seller-object-name').value = receipt.seller_object_name || '';
                document.getElementById('receipt-quantity').value = receipt.quantity;
                populateSelect('receipt-seller-id', sellersCache, 'id', 'name', receipt.seller_id);
                populateSelect('receipt-theme-id', themesCache, 'id', 'name', receipt.theme_id);
                document.getElementById('receipt-location').value = receipt.location || '';

                document.getElementById('edit-receipt-modal').classList.add('active');
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        async function handleReceiptSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/receipt', {
                    method: 'PUT',
                    body: formData
                });
                const result = await response.json();

                closeReceiptModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeReceiptModal() {
            document.getElementById('edit-receipt-modal').classList.remove('active');
        }

        function confirmDeleteReceipt(id) {
            if (!currentUser) {
                showMessage(false, '–û—à–∏–±–∫–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            currentDeleteType = 'receipt';
            currentDeleteId = id;
            document.getElementById('delete-message').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ?';
            document.getElementById('confirm-delete-btn').onclick = executeDelete;
            document.getElementById('delete-modal').classList.add('active');
        }

        // ==================== WRITEOFF CRUD ====================
        async function editWriteoff(id) {
            if (!currentUser) {
                showMessage(false, '–û—à–∏–±–∫–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            try {
                const response = await fetch(`/api/writeoff?id=${id}`);
                const writeoff = await response.json();

                document.getElementById('writeoff-id').value = writeoff.id;
                populateSelect('writeoff-object-id', objectsCache,
                    'id', 'objectname', writeoff.object_id);
                document.getElementById('writeoff-date').value =
                    writeoff.writeoff_date || '';
                document.getElementById('writeoff-quantity').value =
                    writeoff.quantity;
                populateSelect('writeoff-theme-id', themesCache,
                    'id', 'name', writeoff.theme_id);

                const docInfo =
                    document.getElementById('writeoff-doc-info');
                if (writeoff.document_filename) {
                    docInfo.textContent =
                        `–¢–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç: ${writeoff.document_filename}` +
                        ` (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)`;
                } else {
                    docInfo.textContent = '';
                }

                document.getElementById('edit-writeoff-modal')
                    .classList.add('active');
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        async function handleWriteoffSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/api/writeoff', {
                    method: 'PUT',
                    body: formData
                });
                const result = await response.json();

                closeWriteoffModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeWriteoffModal() {
            document.getElementById('edit-writeoff-modal').classList.remove('active');
        }

        function confirmDeleteWriteoff(id) {
            if (!currentUser) {
                showMessage(false, '–û—à–∏–±–∫–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            currentDeleteType = 'writeoff';
            currentDeleteId = id;
            document.getElementById('delete-message').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–ø–∏—Å–∞–Ω–∏–µ?';
            document.getElementById('confirm-delete-btn').onclick = executeDelete;
            document.getElementById('delete-modal').classList.add('active');
        }

        // ==================== PRICING CRUD ====================
        function addPricing(receiptId) {
            if (!currentUser) {
                showMessage(false, '–û—à–∏–±–∫–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            document.getElementById('pricing-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É';
            document.getElementById('pricing-id').value = '';
            document.getElementById('pricing-receipt-id').value = receiptId;
            document.getElementById('pricing-price').value = '';
            document.getElementById('pricing-tax').value = '20';
            document.getElementById('pricing-modal').classList.add('active');
        }

        async function editPricing(receiptId) {
            if (!currentUser) {
                showMessage(false, '–û—à–∏–±–∫–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            try {
                const response = await fetch(`/api/pricing?receipt_id=${receiptId}`);
                const pricing = await response.json();

                if (pricing && pricing.id) {
                    document.getElementById('pricing-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É';
                    document.getElementById('pricing-id').value = pricing.id;
                    document.getElementById('pricing-receipt-id').value = receiptId;
                    document.getElementById('pricing-price').value = pricing.price;
                    document.getElementById('pricing-tax').value = pricing.tax;
                    document.getElementById('pricing-modal').classList.add('active');
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        async function handlePricingSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const isEdit = formData.get('id') !== '';

            try {
                const response = await fetch('/api/pricing', {
                    method: isEdit ? 'PUT' : 'POST',
                    body: formData
                });
                const result = await response.json();

                closePricingModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closePricingModal() {
            document.getElementById('pricing-modal').classList.remove('active');
        }

        // ==================== DELETE ====================
        async function executeDelete() {
            try {
                const response = await fetch(`/api/${currentDeleteType}?id=${currentDeleteId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                closeDeleteModal();

                if (result.error) {
                    showMessage(false, '–û—à–∏–±–∫–∞', result.error);
                } else {
                    showMessage(true, '–£—Å–ø–µ—à–Ω–æ!', result.message);
                    await refreshCurrentView();
                }
            } catch (error) {
                showMessage(false, '–û—à–∏–±–∫–∞', error.message);
            }
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
        }

        // ==================== MESSAGES ====================
        function showMessage(success, title, message) {
            document.getElementById('message-icon').textContent = success ? '‚úì' : '‚úó';
            document.getElementById('message-icon').className = 'modal-icon ' + (success ? 'success' : 'error');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-modal').classList.add('active');
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.remove('active');
        }
    </script>
</body>
</html>