<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>üì¶ –°–∫–ª–∞–¥ - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤</h1>
            <a href="/add" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å</a>
        </div>
        <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="objects-list"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadObjects);

        async function loadObjects() {
            const loadingDiv = document.getElementById('loading');
            const listDiv = document.getElementById('objects-list');

            try {
                const response = await fetch('/api/objects');
                const objects = await response.json();

                loadingDiv.style.display = 'none';

                if (objects.length === 0) {
                    listDiv.innerHTML = '<p class="no-data">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>';
                    return;
                }

                listDiv.innerHTML = objects.map(createObjectRow).join('');
            } catch (error) {
                loadingDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            }
        }

        function createObjectRow(obj) {
            const balanceClass = obj.balance > 0 ? 'positive' : (obj.balance < 0 ? 'negative' : 'zero');

            return `
                <div class="object-card" id="object-${obj.id}">
                    <div class="object-header" onclick="toggleDetails(${obj.id})">
                        <div class="object-name">
                            <span class="expand-icon" id="icon-${obj.id}">‚ñ∂</span>
                            ${obj.objectname}
                        </div>
                        <div class="object-stats">
                            <span class="stat">
                                <label>–ü–æ—Å—Ç—É–ø–∏–ª–æ:</label>
                                <value>${obj.amount}</value>
                            </span>
                            <span class="stat">
                                <label>–°–ø–∏—Å–∞–Ω–æ:</label>
                                <value>${obj.write_off}</value>
                            </span>
                            <span class="stat ${balanceClass}">
                                <label>–û—Å—Ç–∞—Ç–æ–∫:</label>
                                <value>${obj.balance}</value>
                            </span>
                        </div>
                    </div>
                    <div class="object-details" id="details-${obj.id}" style="display: none;">
                        <div class="details-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            `;
        }

        async function toggleDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);
            const icon = document.getElementById(`icon-${objectId}`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                icon.textContent = '‚ñº';

                if (detailsDiv.querySelector('.details-loading')) {
                    await loadObjectDetails(objectId);
                }
            } else {
                detailsDiv.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        async function loadObjectDetails(objectId) {
            const detailsDiv = document.getElementById(`details-${objectId}`);

            try {
                const response = await fetch(`/api/object_details?id=${objectId}`);
                const details = await response.json();

                detailsDiv.innerHTML = renderReceipts(details.receipts) + renderWriteoffs(details.writeoffs);
            } catch (error) {
                detailsDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</p>';
            }
        }

        function createFileLink(type, id, number) {
            if (!id || !number) return '-';
            return `<a href="/api/file/${type}/${id}" target="_blank">${number}</a>`;
        }

        function renderReceipts(receipts) {
            let html = '<div class="section"><h3>üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>';

            if (receipts.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</p></div>';
            }

            html += `
                <table class="details-table">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                        <th>–¢–µ–º–∞</th>
                        <th>–°—á—ë—Ç</th>
                        <th>–î–∞—Ç–∞ —Å—á—ë—Ç–∞</th>
                        <th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>
                        <th>–î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</th>
                        <th>–í—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î–∞—Ç–∞ –≤—Ö. –∫–æ–Ω—Ç—Ä–æ–ª—è</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                    </tr>
            `;

            for (const r of receipts) {
                html += `
                    <tr>
                        <td>${r.object_name || '-'}</td>
                        <td>${r.sellerobjectname || '-'}</td>
                        <td>${r.quantity}</td>
                        <td>${r.seller_name || '-'}</td>
                        <td>${r.theme_name || '-'}</td>
                        <td>${createFileLink('bill', r.bill_id, r.bill_number)}</td>
                        <td>${r.bill_date || '-'}</td>
                        <td>${createFileLink('invoice', r.invoice_id, r.invoice_number)}</td>
                        <td>${r.invoice_date || '-'}</td>
                        <td>${createFileLink('entry_control', r.entry_control_id, r.entry_control_number)}</td>
                        <td>${r.entry_control_date || '-'}</td>
                        <td>${r.location || '-'}</td>
                    </tr>
                `;
            }

            return html + '</table></div>';
        }

        function renderWriteoffs(writeoffs) {
            let html = '<div class="section"><h3>üì§ –°–ø–∏—Å–∞–Ω–∏—è</h3>';

            if (writeoffs.length === 0) {
                return html + '<p class="no-data">–ù–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π</p></div>';
            }

            html += `
                <table class="details-table">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–¢–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è</th>
                    </tr>
            `;

            for (const w of writeoffs) {
                html += `
                    <tr>
                        <td>${w.object_name || '-'}</td>
                        <td>${w.seller_object_name || '-'}</td>
                        <td>${w.quantity}</td>
                        <td>${w.theme_name || '-'}</td>
                    </tr>
                `;
            }

            return html + '</table></div>';
        }
    </script>
</body>
</html>